# THETA åç«¯å®ç°æ¸…å•

**æ›´æ–°æ—¶é—´**: 2025-01-11  
**çŠ¶æ€**: å¾…å®ç°

æœ¬æ–‡æ¡£è¯¦ç»†åˆ—å‡ºäº† THETA é¡¹ç›®éœ€è¦å®ç°çš„æ‰€æœ‰åç«¯åŠŸèƒ½ï¼ŒåŒ…æ‹¬ API æ¥å£ã€æ•°æ®åº“è®¾è®¡ã€æœåŠ¡æ¨¡å—ç­‰ã€‚

---

## ğŸ“‹ ç›®å½•

1. [API æ¥å£æ¸…å•](#api-æ¥å£æ¸…å•)
2. [æ•°æ®åº“è®¾è®¡](#æ•°æ®åº“è®¾è®¡)
3. [æœåŠ¡æ¨¡å—](#æœåŠ¡æ¨¡å—)
4. [æ–‡ä»¶å­˜å‚¨](#æ–‡ä»¶å­˜å‚¨)
5. [ä»»åŠ¡é˜Ÿåˆ—](#ä»»åŠ¡é˜Ÿåˆ—)
6. [AI Agent é›†æˆ](#ai-agent-é›†æˆ)
7. [RAG ç³»ç»Ÿ](#rag-ç³»ç»Ÿ)
8. [åˆ†æå¼•æ“](#åˆ†æå¼•æ“)
9. [éƒ¨ç½²é…ç½®](#éƒ¨ç½²é…ç½®)

---

## ğŸ”Œ API æ¥å£æ¸…å•

### åŸºç¡€é…ç½®

**åŸºç¡€è·¯å¾„**: `/api`  
**æ¡†æ¶**: FastAPI (æ¨è) æˆ– Flask  
**è®¤è¯**: JWT Token (å¯é€‰ï¼Œç”¨äºå¤šç”¨æˆ·åœºæ™¯)

### 1. æ–‡ä»¶ä¸Šä¼ ä¸ç®¡ç†

#### 1.1 æ–‡ä»¶ä¸Šä¼ 
- **ç«¯ç‚¹**: `POST /api/upload`
- **åŠŸèƒ½**: æ¥æ”¶æ–‡ä»¶ä¸Šä¼ ï¼Œä¿å­˜åˆ°å­˜å‚¨ç³»ç»Ÿ
- **è¯·æ±‚**:
  ```json
  {
    "file": File (multipart/form-data),
    "metadata": {
      "filename": "string",
      "type": "csv|xlsx|json"
    }
  }
  ```
- **å“åº”**:
  ```json
  {
    "success": true,
    "data": {
      "fileId": "string (UUID)",
      "filename": "string",
      "size": 12345,
      "type": "string",
      "uploadedAt": "2025-01-11T10:00:00Z"
    }
  }
  ```
- **å®ç°è¦ç‚¹**:
  - æ”¯æŒå¤§æ–‡ä»¶ä¸Šä¼ ï¼ˆåˆ†å—ä¸Šä¼ ï¼‰
  - æ–‡ä»¶ç±»å‹éªŒè¯ï¼ˆCSVã€Excelã€JSONï¼‰
  - æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆå¦‚ 50MBï¼‰
  - ç—…æ¯’æ‰«æï¼ˆå¯é€‰ï¼‰
  - æ–‡ä»¶å»é‡ï¼ˆMD5/SHA256ï¼‰

#### 1.2 æ–‡ä»¶è§£æ
- **ç«¯ç‚¹**: `GET /api/parse-file?fileId={fileId}`
- **åŠŸèƒ½**: è§£æä¸Šä¼ çš„æ–‡ä»¶ï¼Œæå–è¡¨å¤´å’Œæ•°æ®æ ·æœ¬
- **å“åº”**:
  ```json
  {
    "success": true,
    "data": {
      "headers": ["column1", "column2", "column3"],
      "rowCount": 1000,
      "sampleRows": [
        {"column1": "value1", "column2": "value2"}
      ],
      "encoding": "UTF-8",
      "delimiter": ","
    }
  }
  ```
- **å®ç°è¦ç‚¹**:
  - è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç¼–ç ï¼ˆUTF-8ã€GBKã€GB2312ï¼‰
  - è‡ªåŠ¨æ£€æµ‹ CSV åˆ†éš”ç¬¦
  - å¤„ç† Excel å¤šå·¥ä½œè¡¨
  - è¿‡æ»¤ç©ºè¡Œ
  - æ•°æ®ç±»å‹æ¨æ–­

#### 1.3 æ–‡ä»¶åˆ—è¡¨
- **ç«¯ç‚¹**: `GET /api/files`
- **åŠŸèƒ½**: è·å–ç”¨æˆ·ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨
- **æŸ¥è¯¢å‚æ•°**: `?page=1&limit=20&type=csv`

#### 1.4 æ–‡ä»¶åˆ é™¤
- **ç«¯ç‚¹**: `DELETE /api/files/{fileId}`
- **åŠŸèƒ½**: åˆ é™¤ä¸Šä¼ çš„æ–‡ä»¶

---

### 2. åˆ†æä»»åŠ¡ç®¡ç†

#### 2.1 å¯åŠ¨åˆ†æä»»åŠ¡
- **ç«¯ç‚¹**: `POST /api/analyze`
- **åŠŸèƒ½**: å¯åŠ¨ä¸»é¢˜åˆ†æä»»åŠ¡
- **è¯·æ±‚**:
  ```json
  {
    "fileId": "string",
    "fieldMapping": {
      "filename": "string (å­—æ®µå)",
      "content": "string (å­—æ®µå)",
      "modified": "string (å­—æ®µå)"
    },
    "model": "é‡‘è|å¿ƒç†|åŒ»ç–—|å…¬å…±å«ç”Ÿ|æ”¿æ²»|Twitter",
    "config": {
      "numTopics": 50,
      "epochs": 200,
      "batchSize": 256
    }
  }
  ```
- **å“åº”**:
  ```json
  {
    "success": true,
    "data": {
      "taskId": "string (UUID)",
      "status": "pending|processing|completed|failed",
      "createdAt": "2025-01-11T10:00:00Z"
    }
  }
  ```
- **å®ç°è¦ç‚¹**:
  - å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼ˆä½¿ç”¨ Celery æˆ–ç±»ä¼¼ï¼‰
  - å‚æ•°éªŒè¯
  - ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†
  - èµ„æºé™åˆ¶æ£€æŸ¥

#### 2.2 æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
- **ç«¯ç‚¹**: `GET /api/task/{taskId}/status`
- **åŠŸèƒ½**: æŸ¥è¯¢åˆ†æä»»åŠ¡çš„çŠ¶æ€å’Œè¿›åº¦
- **å“åº”**:
  ```json
  {
    "success": true,
    "data": {
      "taskId": "string",
      "status": "pending|processing|completed|failed",
      "progress": 75.5,
      "currentStep": "è®­ç»ƒ ETM æ¨¡å‹",
      "result": {
        "metrics": {
          "f1Score": 0.87,
          "cvScore": 0.92
        },
        "outputPath": "/path/to/results"
      },
      "error": "string (å¦‚æœå¤±è´¥)",
      "createdAt": "2025-01-11T10:00:00Z",
      "updatedAt": "2025-01-11T10:05:00Z"
    }
  }
  ```
- **å®ç°è¦ç‚¹**:
  - å®æ—¶è¿›åº¦æ›´æ–°ï¼ˆWebSocket æˆ– Server-Sent Eventsï¼‰
  - ä»»åŠ¡æ—¥å¿—è®°å½•
  - é”™è¯¯ä¿¡æ¯è¯¦ç»†è®°å½•

#### 2.3 å–æ¶ˆä»»åŠ¡
- **ç«¯ç‚¹**: `POST /api/task/{taskId}/cancel`
- **åŠŸèƒ½**: å–æ¶ˆæ­£åœ¨è¿è¡Œçš„ä»»åŠ¡

#### 2.4 ä»»åŠ¡åˆ—è¡¨
- **ç«¯ç‚¹**: `GET /api/tasks`
- **åŠŸèƒ½**: è·å–ç”¨æˆ·çš„ä»»åŠ¡åˆ—è¡¨
- **æŸ¥è¯¢å‚æ•°**: `?status=completed&page=1&limit=20`

---

### 3. é…ç½®ç®¡ç†

#### 3.1 ä¿å­˜é…ç½®
- **ç«¯ç‚¹**: `POST /api/config`
- **åŠŸèƒ½**: ä¿å­˜ç”¨æˆ·é…ç½®
- **è¯·æ±‚**:
  ```json
  {
    "fieldMapping": {
      "filename": "string",
      "content": "string",
      "modified": "string"
    },
    "selectedModel": "string",
    "uploadedFiles": ["fileId1", "fileId2"]
  }
  ```
- **å“åº”**:
  ```json
  {
    "success": true,
    "data": {
      "configId": "string",
      "savedAt": "2025-01-11T10:00:00Z"
    }
  }
  ```

#### 3.2 è·å–é…ç½®
- **ç«¯ç‚¹**: `GET /api/config`
- **åŠŸèƒ½**: è·å–ç”¨æˆ·ä¿å­˜çš„é…ç½®
- **æŸ¥è¯¢å‚æ•°**: `?configId={configId}` (å¯é€‰ï¼Œä¸ä¼ åˆ™è¿”å›æœ€æ–°é…ç½®)

#### 3.3 åˆ é™¤é…ç½®
- **ç«¯ç‚¹**: `DELETE /api/config/{configId}`

---

### 4. RAG æœç´¢

#### 4.1 RAG æœç´¢
- **ç«¯ç‚¹**: `POST /api/rag/search`
- **åŠŸèƒ½**: æ‰§è¡Œ RAG æ£€ç´¢å¢å¼ºç”Ÿæˆ
- **è¯·æ±‚**:
  ```json
  {
    "query": "ä¸‰çº¿ç»†èƒç™Œ",
    "knowledgeBases": ["kb1", "kb2"],
    "topK": 5
  }
  ```
- **å“åº”**:
  ```json
  {
    "success": true,
    "data": {
      "results": [
        {
          "content": "æ ¹æ®æ£€ç´¢ç»“æœï¼Œä¸‰çº¿ç»†èƒç™Œ...â½1â¾...â½2â¾",
          "citations": [
            {
              "id": 1,
              "source": "ã€Šè‚¿ç˜¤ç—…ç†å­¦åŸºç¡€ã€‹ç¬¬ 3 ç« ï¼Œç¬¬ 45-52 é¡µ",
              "type": "pdf",
              "page": 45,
              "url": "/api/documents/doc123"
            }
          ],
          "score": 0.92
        }
      ]
    }
  }
  ```
- **å®ç°è¦ç‚¹**:
  - å‘é‡æ£€ç´¢ï¼ˆä½¿ç”¨ FAISSã€Milvus æˆ–ç±»ä¼¼ï¼‰
  - é‡æ’åºï¼ˆrerankingï¼‰
  - å¼•ç”¨æ¥æºè¿½è¸ª
  - å¤šçŸ¥è¯†åº“æ”¯æŒ

#### 4.2 è·å–çŸ¥è¯†åº“åˆ—è¡¨
- **ç«¯ç‚¹**: `GET /api/knowledge-bases`
- **åŠŸèƒ½**: è·å–å¯ç”¨çš„çŸ¥è¯†åº“åˆ—è¡¨
- **å“åº”**:
  ```json
  {
    "success": true,
    "data": [
      {
        "id": "kb1",
        "name": "è‚¿ç˜¤ç—…ç†å­¦æ•™æ",
        "type": "pdf",
        "count": 2,
        "description": "string"
      }
    ]
  }
  ```

#### 4.3 è·å–æ–‡æ¡£å†…å®¹
- **ç«¯ç‚¹**: `GET /api/documents/{docId}`
- **åŠŸèƒ½**: è·å–æ–‡æ¡£çš„è¯¦ç»†å†…å®¹
- **å“åº”**:
  ```json
  {
    "success": true,
    "data": {
      "id": "doc123",
      "content": "æ–‡æ¡£å…¨æ–‡å†…å®¹...",
      "metadata": {
        "title": "string",
        "author": "string",
        "pages": 100
      },
      "url": "/path/to/document.pdf"
    }
  }
  ```

#### 4.4 æ·»åŠ æ–‡æ¡£åˆ°çŸ¥è¯†åº“
- **ç«¯ç‚¹**: `POST /api/knowledge-bases/{kbId}/documents`
- **åŠŸèƒ½**: å‘çŸ¥è¯†åº“æ·»åŠ æ–°æ–‡æ¡£

---

### 5. åˆ†ææ•°æ® API

#### 5.1 è·å–æ—¶åºæ•°æ®
- **ç«¯ç‚¹**: `GET /api/analytics/timeline?taskId={taskId}`
- **åŠŸèƒ½**: è·å–ä¸»é¢˜æ¼”åŒ–çš„æ—¶åºæ•°æ®
- **å“åº”**:
  ```json
  {
    "success": true,
    "data": [
      {
        "month": "2019-01",
        "count": 45
      },
      {
        "month": "2019-02",
        "count": 52
      }
    ]
  }
  ```

#### 5.2 è·å– UMAP æ•°æ®
- **ç«¯ç‚¹**: `GET /api/analytics/umap?taskId={taskId}`
- **åŠŸèƒ½**: è·å– UMAP é™ç»´åçš„æ•°æ®ç‚¹
- **å“åº”**:
  ```json
  {
    "success": true,
    "data": [
      {
        "x": 12.5,
        "y": 34.2,
        "cluster": 0,
        "documentId": "doc123"
      }
    ]
  }
  ```

#### 5.3 è·å–å±‚æ¬¡èšç±»æ•°æ®
- **ç«¯ç‚¹**: `GET /api/analytics/hierarchy?taskId={taskId}`
- **åŠŸèƒ½**: è·å–ä¸»é¢˜å±‚æ¬¡èšç±»æ ‘æ•°æ®
- **å“åº”**:
  ```json
  {
    "success": true,
    "data": {
      "id": "root",
      "name": "ä¸»é¢˜æ ¹èŠ‚ç‚¹",
      "children": [
        {
          "id": "topic-1",
          "name": "æ”¿ç­–æ”¹é©",
          "value": 45,
          "children": [...]
        }
      ]
    }
  }
  ```

#### 5.4 è·å–å…³é”®è¯æ•°æ®
- **ç«¯ç‚¹**: `GET /api/analytics/keywords?taskId={taskId}`
- **åŠŸèƒ½**: è·å– c-TF-IDF å…³é”®è¯æ•°æ®
- **å“åº”**:
  ```json
  {
    "success": true,
    "data": [
      {
        "word": "æ”¿ç­–æ”¹é©",
        "weight": 95
      }
    ]
  }
  ```

---

### 6. AI Agent æ¥å£

#### 6.1 AI Agent æŸ¥è¯¢
- **ç«¯ç‚¹**: `POST /api/agent/query`
- **åŠŸèƒ½**: å‘é€æŸ¥è¯¢åˆ° AI Agent
- **è¯·æ±‚**:
  ```json
  {
    "message": "è¯·åˆ†æè¿™ä¸ªä¸»é¢˜",
    "context": {
      "taskId": "task123",
      "topicId": 5
    }
  }
  ```
- **å“åº”**:
  ```json
  {
    "success": true,
    "data": {
      "message": "AI ç”Ÿæˆçš„å›å¤",
      "type": "info|success|tip|framework|evidence|source|metric|insight|recommendation"
    }
  }
  ```

#### 6.2 AI Agent æ¶ˆæ¯æµ
- **ç«¯ç‚¹**: `WebSocket /api/agent/stream`
- **åŠŸèƒ½**: å®æ—¶æ¥æ”¶ AI Agent æ¶ˆæ¯æµ
- **æ¶ˆæ¯æ ¼å¼**:
  ```json
  {
    "type": "message|progress|error",
    "data": {
      "text": "string",
      "progress": 50
    }
  }
  ```

---

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### æ•°æ®åº“é€‰æ‹©
- **ä¸»æ•°æ®åº“**: PostgreSQL (æ¨è) æˆ– MySQL
- **ç¼“å­˜**: Redis
- **å‘é‡æ•°æ®åº“**: Milvus / FAISS / Pinecone (ç”¨äº RAG)

### æ•°æ®è¡¨è®¾è®¡

#### 1. users (ç”¨æˆ·è¡¨)
```sql
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 2. files (æ–‡ä»¶è¡¨)
```sql
CREATE TABLE files (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    filename VARCHAR(255) NOT NULL,
    original_filename VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size BIGINT NOT NULL,
    file_type VARCHAR(50) NOT NULL,
    mime_type VARCHAR(100),
    md5_hash VARCHAR(32),
    encoding VARCHAR(20),
    row_count INTEGER,
    headers JSONB,
    metadata JSONB,
    status VARCHAR(20) DEFAULT 'uploaded',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_md5_hash (md5_hash)
);
```

#### 3. tasks (ä»»åŠ¡è¡¨)
```sql
CREATE TABLE tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    file_id UUID REFERENCES files(id),
    name VARCHAR(255),
    status VARCHAR(20) DEFAULT 'pending',
    progress FLOAT DEFAULT 0.0,
    current_step VARCHAR(255),
    config JSONB NOT NULL,
    result JSONB,
    error_message TEXT,
    started_at TIMESTAMP,
    completed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at)
);
```

#### 4. task_logs (ä»»åŠ¡æ—¥å¿—è¡¨)
```sql
CREATE TABLE task_logs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,
    level VARCHAR(20) NOT NULL,
    message TEXT NOT NULL,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_task_id (task_id),
    INDEX idx_created_at (created_at)
);
```

#### 5. configs (é…ç½®è¡¨)
```sql
CREATE TABLE configs (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    name VARCHAR(255),
    field_mapping JSONB NOT NULL,
    selected_model VARCHAR(50),
    uploaded_files UUID[],
    is_default BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id)
);
```

#### 6. knowledge_bases (çŸ¥è¯†åº“è¡¨)
```sql
CREATE TABLE knowledge_bases (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id),
    name VARCHAR(255) NOT NULL,
    type VARCHAR(50) NOT NULL,
    description TEXT,
    document_count INTEGER DEFAULT 0,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user_id (user_id)
);
```

#### 7. documents (æ–‡æ¡£è¡¨)
```sql
CREATE TABLE documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    knowledge_base_id UUID REFERENCES knowledge_bases(id) ON DELETE CASCADE,
    title VARCHAR(255),
    content TEXT NOT NULL,
    content_type VARCHAR(50),
    file_path VARCHAR(500),
    metadata JSONB,
    embedding VECTOR(768), -- å¦‚æœä½¿ç”¨ PostgreSQL + pgvector
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_kb_id (knowledge_base_id),
    INDEX idx_created_at (created_at)
);
```

#### 8. analysis_results (åˆ†æç»“æœè¡¨)
```sql
CREATE TABLE analysis_results (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,
    result_type VARCHAR(50) NOT NULL, -- timeline, umap, hierarchy, keywords
    data JSONB NOT NULL,
    file_path VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_task_id (task_id),
    INDEX idx_result_type (result_type)
);
```

#### 9. topics (ä¸»é¢˜è¡¨)
```sql
CREATE TABLE topics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    task_id UUID REFERENCES tasks(id) ON DELETE CASCADE,
    topic_id INTEGER NOT NULL,
    words JSONB NOT NULL, -- [{"word": "æ”¿ç­–", "weight": 0.95}]
    document_count INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(task_id, topic_id),
    INDEX idx_task_id (task_id)
);
```

---

## ğŸ”§ æœåŠ¡æ¨¡å—

### 1. æ–‡ä»¶æœåŠ¡ (File Service)
- **æ–‡ä»¶**: `services/file_service.py`
- **åŠŸèƒ½**:
  - æ–‡ä»¶ä¸Šä¼ å¤„ç†
  - æ–‡ä»¶è§£æï¼ˆCSVã€Excelã€JSONï¼‰
  - æ–‡ä»¶å­˜å‚¨ç®¡ç†
  - æ–‡ä»¶å»é‡
  - æ–‡ä»¶åˆ é™¤

### 2. ä»»åŠ¡æœåŠ¡ (Task Service)
- **æ–‡ä»¶**: `services/task_service.py`
- **åŠŸèƒ½**:
  - ä»»åŠ¡åˆ›å»ºå’Œç®¡ç†
  - ä»»åŠ¡çŠ¶æ€æ›´æ–°
  - ä»»åŠ¡è¿›åº¦è·Ÿè¸ª
  - ä»»åŠ¡æ—¥å¿—è®°å½•
  - ä»»åŠ¡å–æ¶ˆ

### 3. åˆ†ææœåŠ¡ (Analysis Service)
- **æ–‡ä»¶**: `services/analysis_service.py`
- **åŠŸèƒ½**:
  - è°ƒç”¨ ETM è®­ç»ƒæµç¨‹
  - ç”Ÿæˆåˆ†æç»“æœ
  - è®¡ç®—æŒ‡æ ‡ï¼ˆF1-Scoreã€Cv Scoreï¼‰
  - æ•°æ®å¯è§†åŒ–æ•°æ®ç”Ÿæˆ

### 4. RAG æœåŠ¡ (RAG Service)
- **æ–‡ä»¶**: `services/rag_service.py`
- **åŠŸèƒ½**:
  - æ–‡æ¡£å‘é‡åŒ–
  - å‘é‡æ£€ç´¢
  - é‡æ’åº
  - å¼•ç”¨ç”Ÿæˆ
  - çŸ¥è¯†åº“ç®¡ç†

### 5. é…ç½®æœåŠ¡ (Config Service)
- **æ–‡ä»¶**: `services/config_service.py`
- **åŠŸèƒ½**:
  - é…ç½®ä¿å­˜å’ŒåŠ è½½
  - é…ç½®éªŒè¯
  - é…ç½®ç‰ˆæœ¬ç®¡ç†

### 6. AI Agent æœåŠ¡ (Agent Service)
- **æ–‡ä»¶**: `services/agent_service.py`
- **åŠŸèƒ½**:
  - ä¸ Topic-Aware Agent é›†æˆ
  - æ¶ˆæ¯ç”Ÿæˆ
  - ä¸Šä¸‹æ–‡ç®¡ç†
  - WebSocket è¿æ¥ç®¡ç†

---

## ğŸ“ æ–‡ä»¶å­˜å‚¨

### å­˜å‚¨ç»“æ„
```
storage/
â”œâ”€â”€ uploads/
â”‚   â””â”€â”€ {user_id}/
â”‚       â””â”€â”€ {file_id}/
â”‚           â””â”€â”€ original.{ext}
â”œâ”€â”€ processed/
â”‚   â””â”€â”€ {task_id}/
â”‚       â”œâ”€â”€ data.jsonl
â”‚       â””â”€â”€ embeddings.npy
â”œâ”€â”€ results/
â”‚   â””â”€â”€ {task_id}/
â”‚       â”œâ”€â”€ timeline.json
â”‚       â”œâ”€â”€ umap.json
â”‚       â”œâ”€â”€ hierarchy.json
â”‚       â”œâ”€â”€ keywords.json
â”‚       â””â”€â”€ models/
â”‚           â”œâ”€â”€ etm_model.pt
â”‚           â””â”€â”€ vocab.json
â””â”€â”€ knowledge_bases/
    â””â”€â”€ {kb_id}/
        â””â”€â”€ documents/
            â””â”€â”€ {doc_id}.pdf
```

### å­˜å‚¨æ–¹æ¡ˆ
- **æœ¬åœ°å­˜å‚¨**: é€‚ç”¨äºå¼€å‘å’Œå°è§„æ¨¡éƒ¨ç½²
- **å¯¹è±¡å­˜å‚¨**: AWS S3ã€é˜¿é‡Œäº‘ OSSã€MinIOï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
- **æ–‡ä»¶ç³»ç»Ÿ**: éœ€è¦æ”¯æŒå¤§æ–‡ä»¶å’Œå¹¶å‘è®¿é—®

---

## ğŸ”„ ä»»åŠ¡é˜Ÿåˆ—

### é˜Ÿåˆ—ç³»ç»Ÿ
- **æ¨è**: Celery + Redis/RabbitMQ
- **æ›¿ä»£**: RQ (Redis Queue)ã€Dramatiq

### ä»»åŠ¡ç±»å‹

#### 1. æ–‡ä»¶è§£æä»»åŠ¡
```python
@celery.task
def parse_file_task(file_id: str):
    # è§£ææ–‡ä»¶
    # æå–è¡¨å¤´
    # ä¿å­˜è§£æç»“æœ
    pass
```

#### 2. åˆ†æä»»åŠ¡
```python
@celery.task
def analyze_task(task_id: str):
    # æ•°æ®é¢„å¤„ç†
    # ç”ŸæˆåµŒå…¥
    # è®­ç»ƒ ETM
    # ç”Ÿæˆå¯è§†åŒ–æ•°æ®
    # ä¿å­˜ç»“æœ
    pass
```

#### 3. å‘é‡åŒ–ä»»åŠ¡
```python
@celery.task
def vectorize_document_task(doc_id: str):
    # æ–‡æ¡£å‘é‡åŒ–
    # ä¿å­˜åˆ°å‘é‡æ•°æ®åº“
    pass
```

---

## ğŸ¤– AI Agent é›†æˆ

### ç°æœ‰ Agent API
- **ä½ç½®**: `ETM/agent/api/app.py`
- **å·²æœ‰ç«¯ç‚¹**:
  - `POST /chat` - èŠå¤©æ¥å£
  - `POST /documents` - æ·»åŠ æ–‡æ¡£
  - `POST /query` - æŸ¥è¯¢çŸ¥è¯†åº“
  - `GET /topics/{topic_id}/words` - è·å–ä¸»é¢˜è¯
  - `POST /analyze` - åˆ†ææ–‡æœ¬

### é›†æˆæ–¹å¼
1. **ç›´æ¥è°ƒç”¨**: é€šè¿‡ HTTP è¯·æ±‚è°ƒç”¨ Agent API
2. **Python å¯¼å…¥**: ç›´æ¥å¯¼å…¥ Agent ç±»ä½¿ç”¨
3. **æ¶ˆæ¯é˜Ÿåˆ—**: é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥è°ƒç”¨

---

## ğŸ” RAG ç³»ç»Ÿ

### ç»„ä»¶éœ€æ±‚

#### 1. å‘é‡æ•°æ®åº“
- **é€‰é¡¹**: Milvusã€FAISSã€Pineconeã€Weaviate
- **åŠŸèƒ½**: å­˜å‚¨æ–‡æ¡£å‘é‡ï¼Œæ”¯æŒç›¸ä¼¼åº¦æœç´¢

#### 2. åµŒå…¥æ¨¡å‹
- **é€‰é¡¹**: 
  - ä¸­æ–‡: text2vecã€m3e-base
  - å¤šè¯­è¨€: sentence-transformers
  - é¢†åŸŸç‰¹å®š: ä½¿ç”¨ LoRA å¾®è°ƒçš„æ¨¡å‹

#### 3. æ£€ç´¢æµç¨‹
1. æŸ¥è¯¢å‘é‡åŒ–
2. å‘é‡æ£€ç´¢ï¼ˆTop-Kï¼‰
3. é‡æ’åºï¼ˆå¯é€‰ï¼‰
4. ç”Ÿæˆå›ç­”ï¼ˆLLMï¼‰
5. å¼•ç”¨æ ‡æ³¨

### çŸ¥è¯†åº“ç®¡ç†
- çŸ¥è¯†åº“åˆ›å»ºå’Œåˆ é™¤
- æ–‡æ¡£æ‰¹é‡å¯¼å…¥
- æ–‡æ¡£æ›´æ–°å’Œåˆ é™¤
- å‘é‡ç´¢å¼•é‡å»º

---

## ğŸ§® åˆ†æå¼•æ“

### ETM è®­ç»ƒæµç¨‹
1. **æ•°æ®åŠ è½½**: ä»æ–‡ä»¶åŠ è½½æ•°æ®
2. **é¢„å¤„ç†**: æ¸…æ´—ã€åˆ†è¯ã€å»åœç”¨è¯
3. **è¯æ±‡è¡¨æ„å»º**: ç”Ÿæˆè¯æ±‡è¡¨
4. **åµŒå…¥ç”Ÿæˆ**: ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹ç”ŸæˆåµŒå…¥
5. **ETM è®­ç»ƒ**: è®­ç»ƒä¸»é¢˜æ¨¡å‹
6. **ç»“æœç”Ÿæˆ**: 
   - ä¸»é¢˜-è¯åˆ†å¸ƒ (beta)
   - æ–‡æ¡£-ä¸»é¢˜åˆ†å¸ƒ (theta)
   - ä¸»é¢˜å…³é”®è¯
   - å¯è§†åŒ–æ•°æ®

### å¯è§†åŒ–æ•°æ®ç”Ÿæˆ
1. **æ—¶åºæ•°æ®**: æŒ‰æ—¶é—´èšåˆä¸»é¢˜åˆ†å¸ƒ
2. **UMAP é™ç»´**: å°†é«˜ç»´åµŒå…¥é™ç»´åˆ° 2D
3. **å±‚æ¬¡èšç±»**: æ„å»ºä¸»é¢˜å±‚æ¬¡æ ‘
4. **å…³é”®è¯æå–**: c-TF-IDF è®¡ç®—

---

## ğŸš€ éƒ¨ç½²é…ç½®

### ç¯å¢ƒå˜é‡
```bash
# æ•°æ®åº“
DATABASE_URL=postgresql://user:pass@localhost:5432/theta
REDIS_URL=redis://localhost:6379/0

# æ–‡ä»¶å­˜å‚¨
STORAGE_TYPE=local|s3|oss
STORAGE_PATH=/path/to/storage
S3_BUCKET=theta-storage
S3_ACCESS_KEY=xxx
S3_SECRET_KEY=xxx

# å‘é‡æ•°æ®åº“
VECTOR_DB_TYPE=milvus|faiss
MILVUS_HOST=localhost
MILVUS_PORT=19530

# AI Agent
AGENT_API_URL=http://localhost:8001
LLM_API_KEY=xxx
LLM_BASE_URL=xxx

# ä»»åŠ¡é˜Ÿåˆ—
CELERY_BROKER_URL=redis://localhost:6379/1
CELERY_RESULT_BACKEND=redis://localhost:6379/2

# æœåŠ¡å™¨
API_HOST=0.0.0.0
API_PORT=8000
CORS_ORIGINS=http://localhost:3000
```

### Docker Compose é…ç½®
```yaml
version: '3.8'
services:
  api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@db:5432/theta
    depends_on:
      - db
      - redis
  
  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=theta
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
  
  redis:
    image: redis:7-alpine
  
  celery:
    build: .
    command: celery -A app.celery worker --loglevel=info
    depends_on:
      - db
      - redis
  
  milvus:
    image: milvusdb/milvus:latest
    ports:
      - "19530:19530"
```

---

## ğŸ“Š å®ç°ä¼˜å…ˆçº§

### ğŸ”¥ ç¬¬ä¸€é˜¶æ®µï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
1. æ–‡ä»¶ä¸Šä¼ å’Œè§£æ API
2. åˆ†æä»»åŠ¡ç®¡ç† API
3. ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢ API
4. åŸºç¡€æ•°æ®åº“è®¾è®¡
5. æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿ

### âš¡ ç¬¬äºŒé˜¶æ®µï¼ˆé‡è¦åŠŸèƒ½ï¼‰
6. RAG æœç´¢ API
7. åˆ†ææ•°æ® APIï¼ˆtimelineã€umapã€hierarchyã€keywordsï¼‰
8. é…ç½®ç®¡ç† API
9. ä»»åŠ¡é˜Ÿåˆ—é›†æˆ

### ğŸ“ ç¬¬ä¸‰é˜¶æ®µï¼ˆå¢å¼ºåŠŸèƒ½ï¼‰
10. AI Agent å®æ—¶æ¶ˆæ¯æµï¼ˆWebSocketï¼‰
11. çŸ¥è¯†åº“ç®¡ç† API
12. ç”¨æˆ·è®¤è¯å’Œæˆæƒ
13. æ€§èƒ½ä¼˜åŒ–å’Œç¼“å­˜

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å‰ç«¯ API ç«¯ç‚¹å®šä¹‰](./theta-nlp-mining/lib/api/endpoints.ts)
- [å‰ç«¯æœåŠ¡æ¥å£](./theta-nlp-mining/lib/api/services.ts)
- [ETM Agent API](./ETM/agent/api/app.py)
- [æœªå®ç°åŠŸèƒ½æ¸…å•](./theta-nlp-mining/æœªå®ç°åŠŸèƒ½æ¸…å•.md)

---

**æœ€åæ›´æ–°**: 2025-01-11  
**ç»´æŠ¤è€…**: THETA å¼€å‘å›¢é˜Ÿ
